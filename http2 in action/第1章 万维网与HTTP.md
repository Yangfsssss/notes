***第1章 万维网与HTTP***

​	本章要点

​	• 浏览器是怎么加载网页的

​	• HTTP是干什么的，及其向HTTP/1.1的演进

​	• HTTPS简介

​	• 基本的HTTP工具

​		本章首先介绍万维网的背景及原理，同时解释本书后面要用到的重要概念，然后再介绍HTTP及其历史版本。

​	***1.1 万维网的原理***

​		HTTP是访问远程Web应用和资源的关键技术，是万维网浏览器或网页浏览器请求网页的协议。

​		因特网是使用IP（Internet Protocol，因特网协议）连接在一起实现消息传递的计算机构成的网络。

​		因特网上有很多服务，万维网（World Wide Web，简称Web）是因特网上的一种服务形式。

​		URL用于标识唯一资源，HTML用于构造网页。

​		因特网上的其他服务同样也使用自己的传输协议及标准，这些协议和标准定义了它们工作的方式，以及底层消息通过因特网传输的方式。

​		IoT设备的原理简单来说，就是通过HTTP调用暴露服务，从而让其他设备（计算机、手机应用，乃至其他IoT设备）使用。

​		万维网（至少为它而发明的HTTP）的持续发展，很可能意味着用不了多久，其真的就可以代表因特网了。

​	***打开网页时会发生什么***

​		浏览器根据DNS（Domain Name System，域名系统）服务器返回的真实地址请求网页，DNS主要负责把对人类友好的www.google.com转换为对机器友好的IP地址。在向DNS查询IP地址时，通常会得到一个距离你最近的服务器的IP地址。

​		浏览器请求计算机建立对这个IP地址的标准Web端口（80）或标准安全Web端口（443）的TCP（Transmission Control Protocol，传输控制协议）连接。

​		IP用于直接通过因特网传输数据（这也是Internet Protocol这个名字的含义），而TCP增加了稳定性与重传机制以确保连接可靠（“嘿，你拿到了吗？”“没有啊，可以再发一次吗？”）。

​		因为这两种技术经常一起使用，通常也被称为TCP/IP，它们是因特网上运行的主要协议。

​		服务器可以提供多种服务（比如电子邮件、FTP、HTTP和HTTPS），而端口可以让不同服务共享同一个IP地址，这非常像公司的电话总机和分机。

​		当浏览器连接到Web服务器之后会请求网站。这一步就要用到HTTP了，浏览器会使用HTTP向Google的服务器请求Google主页。

​		在使用标准端口（80用于HTTP，443用于HTTPS）的情况下，浏览器会隐藏端口号。

​		如果使用的是HTTPS，还会采取额外的步骤进行安全验证，以确保连接安全。

​		Google服务器会根据请求的URL响应相关内容。通常要使用HTML标签将网页内容划分为很多区块，同时为了让用户看到丰富的媒体形式，还会引用其他资源（CSS样式表、JavaScript代码、图片、字体文件，等等）。

​		除了返回HTML页面，服务器还有可能返回一条指向不同位置的指令。这种响应又会导致重复之前的部分或全部步骤，具体取决于新地址的服务器与端口变化多大，比如是不是仍然是同一台服务器上的不同端口（如重定向到HTTPS），当然还有可能会重定向到相同服务器与端口下的不同页面。

​		如果这中间出了什么差错，你的浏览器又会收到一个HTTP响应码，比如最广为人知的错误响应码404 Not Found。

​		Web浏览器负责处理返回的响应。假设返回的响应是HTML，则浏览器就会解析HTML中的代码，并在内存中构建DOM（一种页面的内部表现形式）。处理期间，浏览器可能会发现正常显示页面还需要其他资源（比如CSS、JavaScript和图片）。

​		Web浏览器请求自己需要的额外资源。每个资源都需要以与上述1～5步类似的方式去请求，当然也包含这一步。在这些资源中也有可能引用其他资源。HTTP/2的主要目的是使得请求多资源时更有效率。

​		浏览器在获取了足够的关键资源后，开始在屏幕上渲染页面。但是，选择在屏幕上渲染的时机远没有听起来那么简单。充分理解Web技术，特别是HTTP和HTML/CSS/JavaScript，就会知道如何减少加载过程中的这种页面抖动。

​		在页面刚刚显示在屏幕上之后，浏览器会在后台继续下载其他资源，并在处理完它们之后更新页面。这些资源包括不那么重要的图片和广告追踪脚本。

​		当页面完全被加载后，浏览器会停止显示加载图标（在多数浏览器上都位于地址栏旁边），然后触发OnLoad JavaScript事件。根据这个事件，JavaScript就知道可以执行某些操作了。

​		此时，页面已经完全加载了，但浏览器并不会停止发送请求。网页只包含静态内容的时代早就过去了。如今的很多网页其实已经是功能齐全的应用了，因此接下来浏览器还会与因特网上的各种服务端打交道，发送或加载更多内容。

​	***1.2 什么是HTTP***

​		HTTP最初是用来传输超文本文档（文档中包含指向其他文档的链接）的。

​		HTTP基于可靠的网络连接，通常由TCP/IP提供，而TCP/IP建立在某种物理连接之上（如以太网、WiFi等）。基于HTTP的应用应该关注如何处理网络错误或者连接错误，而协议本身并不考虑这些事情。

​		OSI模型（Open System Interconnection，开放式系统互联通信参考模型）是经常用来描述网络分层的概念模型。

​		从本质上来讲，HTTP是一个请求-响应协议。Web浏览器使用HTTP协议，向服务器发送一个请求。服务器响应一个消息，这个消息包含了浏览器所请求的资源。HTTP成功的关键在于简单。为了效率，HTTP/2牺牲了一些简单性。

​		HTTP成功的关键在于它的简单，这使它在服务层面实现起来相对简单。所以，似乎所有可以上网的电脑（从复杂的服务器到IoT中的灯泡）都可以实现HTTP，并直接通过网络提供灵活的命令。

​		实现完全符合HTTP规范的Web服务器是一项更加艰巨的任务。同样，网页浏览器也非常复杂，在通过HTTP获取网页（包括HTML、CSS和用于显示网页的JavaScript）后，还有无数其他协议需要处理。但是，创建一个简单的服务来监听HTTP GET请求，以及响应数据，并不困难。

​		HTTP的简单性也促进了微服务体系结构的繁荣，在该结构中，通常基于较轻的应用服务器，如Node.js（Node），应用程序被分成许多独立的Web服务。

​	***1.3 HTTP的语法和历史***

​		在1989年和1990年间，Tim Berners-Lee构建了第一个基于HTTP的Web服务器，以及第一个Web浏览器，用以请求并显示HTML文档。

​		HTTP的无状态特性是一把双刃剑，有利（这很简单）也有弊（因为必须附加HTTP cookies等技术以允许状态跟踪，这对于复杂的应用程序是必需的）。

​		尽管不是正式标准，HTTP/1.0还是新增了一些关键特性，包含：

​		• 更多的请求方法。除了先前定义的GET方法，新增了HEAD和POST方法。

​		• 为所有的消息添加HTTP版本号字段。此字段是可选的，为了向后兼容，默认情况下使用HTTP/0.9。

​		• HTTP首部。它可以与请求和响应一起发送，以提供与正在执行的请求或发送的响应相关的更多信息。

​		• 一个三位整数的响应状态码，（例如）用来表示响应是否成功。此状态码还可以用来表示重定向请求、条件请求和错误状态（404 - Not Found是其中最著名的错误状态之一）。

​		HTTP/1.0旨在记录现实世界中多数Web服务器上已经发生的事情，而不是定义新的功能。特性的扩增给Web带来了大量的新机会。其中，通过使用HTTP响应首部来定义正文中的内容类型，人们终于可以向网页中添加多媒体内容。

​		POST方法就更有趣了，它允许客户端发送数据到Web服务器。

​		POST方法不局限于发送完整的文件，它可以发送更小的数据。

​		POST方法允许将内容作为HTTP请求的一部分从客户端发送到服务器，这表示HTTP请求终于和HTTP响应一样，拥有了正文部分。

​		实际上，GET方法允许将数据包含在URL尾部指定的查询参数中发送，通常放在?字符之后。

​		GET请求是幂等的，而POST请求不是。这意味着对于同一个URL的多个GET请求，应始终返回相同的结果；而对于同一URL请求的多个POST请求，则可能不会返回相同的结果。

​		HTTP/1.1的许多附加功能是通过HTTP首部引入的，HTTP首部本身是在HTTP/1.0中引入的，这意味着HTTP的基本结构在两个版本之间没有变化。强制首部和持久连接是HTTP/1.0语法的两个显著变化。

​	***强制添加Host首部***

​		在设计HTTP协议之初，一个Web服务器只能托管一个网站（但是这个网站上可以有很多部分和页面）。所以URL的主机名部分是不言自明的，因为在发送HTTP请求之前，用户肯定已经连接到了主机。如今，很多Web服务器上面有多个网站（虚拟主机托管），所以告诉服务器要访问哪个网站和访问哪个相对URL同样重要。我们在请求首部中添加Host来实现该功能。

​		将Host作为必选项是HTTP/1.1的重要改进，这使得服务器能够充分利用虚拟主机托管技术，无须顾及因为新增网站而新加独立主机所带来的复杂性，从而使得网络繁荣发展。

​	***持久连接（也就是KEEP-ALIVE）***

​		起初，HTTP仅仅是一个请求-响应协议。客户端打开连接，请求资源，获得响应，然后断开连接。随着互联网的媒体内容变得更加丰富，关闭连接被证明是一种浪费性能的行为。显示一个页面需要多个资源，所以关闭连接之后还要重新打开它，这导致了不必要的延迟。

​		通过指定Connection首部值为"Keep-Alive"，客户端可以要求服务器保持连接打开，以支持发送更多的请求。

​		当使用持久连接时，想要知道响应何时完成可能会更困难。必须使用Content-Length首部来定义消息响应体的长度，以便当整个消息体传输完成后，客户端可以发送一个新请求。

​		客户端或服务器可以在任何时候关闭HTTP连接。因此，即使使用持久连接，客户端和服务器也应该监视连接并处理意外关闭的连接。

​		HTTP/1.1不仅将持久连接添加到文档标准中，还将其作为默认行为。如果服务器确实想要关闭连接，无论出于何种原因，则它必须在响应中显式包含Connection:"close" HTTP首部。

​		由于某些原因（见第2章），管道化并没有流行起来，并且客户端（浏览器）和服务器对管道化的支持都很差。因此，虽然持久连接允许在同一个TCP上顺序发出多个请求，这也是一个很好的性能改进，但大多数HTTP/1.1的实现仍然是遵循请求响应再请求再响应的模式的。当一个请求被处理时，HTTP连接被阻塞，不能用于其他请求。

​	***其他新功能***

​		HTTP/1.1引入了很多其他的新功能，包含：

​		• 除了在HTTP/1.0中定义的GET、POST和HEAD方法之外，HTTP/1.1又定义了新的方法，如PUT、OPTIONS和比较少见的CONNECT、TRACE及DELETE。

​		• 更好的缓存方法。这些方法允许服务器指示客户端将资源（例如CSS文件）存储在浏览器的缓存中，以便在以后需要时重复使用。在HTTP/1.1中引入的Cache-Control HTTP首部比HTTP/1.0中的Expires首部的选项更多。

​		-HTTP cookies，允许HTTP维护状态。

​		-引入字符集（如本章的一些例子所示），在HTTP响应中新增语言选项。

​		-支持代理。

​		-支持权限验证。

​		-新的状态码。

​		-尾随首部（在4.3.3节中讨论）。

​		一些首部是出于安全原因添加的，网站用它们来告诉Web浏览器打开某些可选的安全保护，这样服务端就不必额外实现安全相关的功能（除了发送这些响应首部的功能）。

​		曾经有一个惯例，是在这些首部中包含一个X-来表明它们没有被正式标准化。

​	***1.4 HTTPS简介***

​		HTTP最初是一个纯文本协议。HTTP消息以未加密的方式通过互联网发送，因此在消息被路由到目的地的过程中，任何一方都可以读取到消息。

​		顾名思义，互联网是一个计算机网络，而不是一个点对点系统。互联网无法控制消息的路由方式，作为互联网用户，你不知道有多少第三方会看到你的消息。HTTP消息的传播路径很广泛，消息被从ISP（Internet Service Provider，网络服务提供商）发送到电信公司和其他组织。

​		由于HTTP消息是纯文本的，因此可以在途中被拦截、读取甚至更改。

​		HTTPS是HTTP的安全版本，它使用TLS（Transport Layer Security，传输层加密）协议对传输中的消息进行加密。

​		HTTPS对HTTP消息添加了三个重要概念：

​		• 加密——传输过程中第三方无法读取消息。

​		• 完整性校验——消息在传输过程中未被更改，因为整个加密消息已经过数字签名，并且该签名在解密之前已通过加密验证。

​		• 身份验证——服务器不是伪装的。

​		HTTPS使用公钥加密，服务器在用户首次连接时以数字证书的形式提供公钥。你的浏览器使用此公钥加密消息，只有服务器可以解密，因为只有它拥有配对的私钥。该系统允许你安全地与网站进行通信，而无须事先知道共享密钥。

​		数字证书由浏览器信任的各种CA（Certificate Authorities，证书颁发机构）发布并进行数字签名。HTTPS的一个重大问题是，它只保证你正在连接到该服务器，而不能保证服务器值得信任。

​		HTTPS是基于HTTP构建的，几乎可以与HTTP协议无缝衔接。它默认在不同的端口上服务（使用443端口，而HTTP的默认端口是80）。它有一个不同的URL协议名（https://而不是http://），但除了加密和解密本身以外，它并没有从根本上改变HTTP的语法或消息格式。

​		当客户端连接到HTTPS服务器时，它将经历协商阶段（或者叫TLS握手）。在此过程中，服务器提供公钥，客户端和服务器协商所使用的加密方法，然后协商接下来要使用的共享密钥。（公钥加密很慢，因此公钥仅用于协商共享密钥。为了更好的性能，可用共享密钥加密后续的消息。）

​		客户端和服务器在发送消息之前加密消息，在接收之前解密消息。在配置完成后，HTTPS和HTTP没有区别。

​	***1.5 查看、发送和接收HTTP消息的工具***

​		略

​	***总结***

​		• HTTP是互联网的核心技术之一。

​		• 浏览器加载一个网站会发送多个HTTP请求。

​		• HTTP协议最早是一个简单的基于文本的协议。

​		• HTTP已经变得很复杂了，但是在过去的20多年里基于文本的协议这一点并没有改变。

​		• HTTPS可以加密标准HTTP消息。

​		• 有很多工具可以用来查看、发送HTTP消息。